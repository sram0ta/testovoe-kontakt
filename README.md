# Расширенный компонент создания CRM-сделки (Bitrix24 коробка)

## Установка
1. Скопируйте директорию `local/` и `php_interface/` в корень Bitrix24.
2. Очистите кеш.
3. Убедитесь, что агент зарегистрирован.

## Компонент
Путь: `/local/components/custom/crm.deal.create/`  
Поля формы: Название сделки, Контакт (поиск по ФИО, автоподстановка), Сумма, Описание.  
Если контакт не найден — его можно создать во всплывающем окне.

При сохранении:
- при необходимости создаётся контакт;
- создаётся сделка через `Bitrix\Crm\DealTable::add`;
- стадии присваивается «Новая».

JS‑расширение: `/local/js/custom/crm.deal/` (поиск, модалка, уведомления).

## Стадии и категория
Обновите значения под ваш портал:
- CATEGORY_ID: `0` (общий конвейер) — при необходимости изменить.
- STAGE_NEW_ID: `NEW`
- STAGE_OVERDUE_ID: `OVERDUE`

Изменить можно в:
- параметрах компонента;
- `php_interface/init.php` (константы `CUSTOM_STAGE_*`, `CUSTOM_CATEGORY_ID`).

## Бизнес‑процесс
При создании сделки запускаются активные шаблоны с автозапуском «Создание» (тип документа CRM_DEAL).  
Логика по заданию: если сумма > 100000 — ставится задача руководителю ОП и добавляется комментарий
«Проверка по лимиту суммы».

### Пользовательское активити
Путь: `/local/activities/custom.adddealcomment/`  
Параметры: `DealId`, `Message`.  
Выход: `COMMENT_ID` — ID комментария таймлайна.

## Агент
`custom_agent_overdue_deals()`:
- Находит сделки в стадии «Новая» старше 3 дней (в категории `CUSTOM_CATEGORY_ID`).
- Переводит в «Просрочена» (`CUSTOM_STAGE_OVERDUE_ID`).
- Добавляет комментарий «Автоматический перевод из-за просрочки».
- Период по умолчанию — 1 час.

### Проверка агента
1) Создайте сделку в стадии «Новая» старше 3 дней (или временно измените интервал на 1 минуту).  
2) Запустите агент руками в админке (или дождитесь)
3) Убедитесь в смене стадии и комментарии.

## Примеры REST
Создание контакта:
```bash
curl -X POST "https://site.ru/rest/1/TOKEN/crm.contact.add.json"       -H "Content-Type: application/json"       -d '{"fields": {"NAME":"Иван","LAST_NAME":"Иванов","OPENED":"Y"}}'
```

Создание сделки:
```bash
curl -X POST "https://site.ru/rest/1/TOKEN/crm.deal.add.json"       -H "Content-Type: application/json"       -d '{"fields": {"TITLE":"Тестовая сделка","STAGE_ID":"NEW","CATEGORY_ID":0,"OPPORTUNITY":12345}}'
```

# testovoe-kontakt
